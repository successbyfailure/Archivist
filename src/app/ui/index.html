<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Archivist RAG UI</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f9; }
        h1 { margin-top: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .section { background: #fff; margin-bottom: 16px; padding: 16px; border: 1px solid #dcdce6; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .section h2 { margin-top: 0; }
        label { display: block; margin-top: 8px; font-weight: bold; }
        label span { font-weight: normal; color: #555; }
        input, textarea, button { width: 100%; box-sizing: border-box; }
        input, textarea { margin-top: 4px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { height: 140px; resize: vertical; }
        button { margin-top: 12px; padding: 10px; background: #4f46e5; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button.secondary { background: #0ea5e9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .result { margin-top: 12px; background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 6px; white-space: pre-wrap; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; }
        .stacked > * + * { margin-top: 8px; }
        .pill { display: inline-block; padding: 2px 8px; border-radius: 9999px; background: #e0f2fe; color: #0369a1; font-size: 12px; font-weight: bold; margin-right: 8px; }
        .collection-card { background: #0b1224; color: #e2e8f0; border: 1px solid #1f2937; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
        .collection-card h3 { margin: 0 0 4px 0; font-size: 16px; }
        .muted { color: #94a3b8; font-size: 12px; }
    </style>
</head>
<body>
<h1>Archivist RAG</h1>
<div class="grid">
    <div class="section">
        <h2>Subir archivo</h2>
        <form id="upload-form" class="stacked">
            <label>Collection <input name="collection" placeholder="default" required></label>
            <label>Namespace <input name="namespace" placeholder="(opcional)"></label>
            <label>File <input type="file" name="file" required></label>
            <label>Metadata <input name="metadata" placeholder="valor libre" ></label>
            <label>Chunk size <input type="number" name="chunk_size" min="10" step="10" placeholder="usa el valor por defecto"></label>
            <label>Chunk overlap <input type="number" name="chunk_overlap" min="0" step="5" placeholder="usa el valor por defecto"></label>
            <button type="submit">Upload</button>
        </form>
        <div id="upload-result" class="result"></div>
    </div>

    <div class="section">
        <h2>Vídeo (VHS)</h2>
        <form id="vhs-form" class="stacked">
            <label>Enlace al vídeo <input name="video_url" required placeholder="https://..." /></label>
            <label>Collection <input name="collection" placeholder="default" required></label>
            <label>Namespace <input name="namespace" placeholder="(opcional)"></label>
            <label>Metadata <input name="metadata" placeholder="valor libre" ></label>
            <button type="submit">Enviar a VHS e indexar</button>
        </form>
        <div id="vhs-result" class="result"></div>
    </div>
</div>

<div class="grid">
    <div class="section">
        <h2>Consultar</h2>
        <form id="query-form" class="stacked">
            <label>Query <input name="query" required></label>
            <label>Collection <input name="collection" value="default"></label>
            <label>Namespace <input name="namespace"></label>
            <label>Pipeline <input name="pipeline" placeholder="qa"></label>
            <label><input type="checkbox" name="retrieval_only"> Sólo retrieval</label>
            <label><input type="checkbox" name="stream"> Streaming</label>
            <label><input type="checkbox" name="structured"> Structured</label>
            <label><input type="checkbox" name="partial"> Partial</label>
            <button type="submit">Buscar</button>
        </form>
        <div class="result" id="query-result"></div>
    </div>

    <div class="section">
        <h2>Pipelines disponibles</h2>
        <div class="stacked">
            <button id="refresh-pipelines" class="secondary" type="button">Actualizar lista</button>
            <div id="pipelines" class="result"></div>
        </div>
    </div>

    <div class="section">
        <h2>Métricas básicas</h2>
        <div class="stacked">
            <button id="load-stats" class="secondary" type="button">Cargar /admin/stats</button>
            <div id="stats" class="result"></div>
        </div>
    </div>
</div>

<div class="grid">
    <div class="section">
        <h2>Colecciones</h2>
        <div class="stacked">
            <label>Namespace <input id="collections-namespace" placeholder="(todos)"></label>
            <button id="load-collections" class="secondary" type="button">Ver colecciones</button>
            <div id="collections" class="result"></div>
        </div>
    </div>

    <div class="section">
        <h2>Documentos de la colección</h2>
        <div class="stacked">
            <div id="collection-docs" class="result"></div>
        </div>
    </div>
</div>
<script>
const pretty = (data) => typeof data === 'string' ? data : JSON.stringify(data, null, 2);

const uploadForm = document.getElementById('upload-form');
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadForm);
    const target = document.getElementById('upload-result');
    target.innerText = 'Subiendo...';
    try {
        const res = await fetch('/ingest/file', { method: 'POST', body: formData });
        const text = await res.text();
        target.innerText = text;
    } catch (err) {
        target.innerText = `Error: ${err}`;
    }
});

document.getElementById('vhs-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const target = document.getElementById('vhs-result');
    const formData = new FormData(e.target);
    const payload = new FormData();
    payload.append('video_url', formData.get('video_url'));
    payload.append('collection', formData.get('collection'));
    if (formData.get('metadata')) payload.append('metadata', formData.get('metadata'));
    if (formData.get('namespace')) payload.append('namespace', formData.get('namespace'));
    target.innerText = 'Mandando a VHS...';
    try {
        const res = await fetch('/ingest/vhs', { method: 'POST', body: payload });
        const text = await res.text();
        target.innerText = text;
    } catch (err) {
        target.innerText = `Error: ${err}`;
    }
});

const queryForm = document.getElementById('query-form');
queryForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const target = document.getElementById('query-result');
    target.innerText = 'Buscando...';
    const formData = new FormData(queryForm);
    const payload = Object.fromEntries(formData.entries());
    payload.retrieval_only = formData.get('retrieval_only') === 'on';
    payload.stream = formData.get('stream') === 'on';
    payload.structured = formData.get('structured') === 'on';
    payload.partial = formData.get('partial') === 'on';

    try {
        if (payload.stream) {
            const res = await fetch('/rag/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!res.body) { target.innerText = await res.text(); return; }
            const reader = res.body.getReader();
            let answer = '';
            const decoder = new TextDecoder();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                answer += decoder.decode(value);
                target.innerText = answer;
            }
        } else {
            const res = await fetch('/rag/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const text = await res.text();
            target.innerText = text;
        }
    } catch (err) {
        target.innerText = `Error: ${err}`;
    }
});

const pipelinesDiv = document.getElementById('pipelines');
document.getElementById('refresh-pipelines').addEventListener('click', async () => {
    pipelinesDiv.innerText = 'Cargando...';
    try {
        const res = await fetch('/pipelines');
        const data = await res.json();
        pipelinesDiv.innerHTML = data.map(p => `<div><span class="pill">${p.name}</span>${p.description || ''}</div>`).join('\n');
    } catch (err) {
        pipelinesDiv.innerText = `Error: ${err}`;
    }
});

document.getElementById('load-stats').addEventListener('click', async () => {
    const target = document.getElementById('stats');
    target.innerText = 'Cargando...';
    try {
        const res = await fetch('/admin/stats');
        const data = await res.json();
        target.innerText = pretty(data);
    } catch (err) {
        target.innerText = `Error: ${err}`;
    }
});

const collectionsDiv = document.getElementById('collections');
const collectionDocsDiv = document.getElementById('collection-docs');
document.getElementById('load-collections').addEventListener('click', async () => {
    collectionsDiv.innerText = 'Cargando colecciones...';
    collectionDocsDiv.innerText = '';
    const namespaceValue = document.getElementById('collections-namespace').value.trim();
    const url = namespaceValue ? `/collections?namespace=${encodeURIComponent(namespaceValue)}` : '/collections';
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
            collectionsDiv.innerText = 'No hay colecciones.';
            return;
        }
        collectionsDiv.innerHTML = data.map(c => `
            <div class="collection-card">
                <h3>${c.namespace} / ${c.collection}</h3>
                <div><span class="pill">docs: ${c.documents}</span><span class="pill">chunks: ${c.chunks}</span></div>
                <div class="muted">Idiomas: ${(c.languages || []).join(', ') || 'no detectado'}</div>
                <div class="muted">Última ingesta: ${c.latest_ingested_at ? new Date(c.latest_ingested_at).toLocaleString() : 'N/A'}</div>
                <button class="secondary view-docs" data-namespace="${c.namespace}" data-collection="${c.collection}">Ver documentos</button>
            </div>
        `).join('');
    } catch (err) {
        collectionsDiv.innerText = `Error: ${err}`;
    }
});

collectionsDiv.addEventListener('click', async (event) => {
    const btn = event.target.closest('.view-docs');
    if (!btn) return;
    const namespace = btn.getAttribute('data-namespace');
    const collection = btn.getAttribute('data-collection');
    collectionDocsDiv.innerText = 'Cargando documentos...';
    try {
        const res = await fetch(`/collections/${encodeURIComponent(namespace)}/${encodeURIComponent(collection)}`);
        const docs = await res.json();
        if (!Array.isArray(docs) || docs.length === 0) {
            collectionDocsDiv.innerText = 'Colección vacía.';
            return;
        }
        collectionDocsDiv.innerHTML = docs.map(d => `
            <div class="collection-card">
                <div><strong>v${d.version}</strong> · ${d.id}</div>
                <div class="muted">${new Date(d.created_at).toLocaleString()} · ${d.language || 'idioma desconocido'}</div>
                <div class="muted">Chunks: ${d.chunks}</div>
                <div>${d.snippet || '(sin vista previa)'}</div>
                <pre class="muted">${pretty(d.metadata)}</pre>
            </div>
        `).join('');
    } catch (err) {
        collectionDocsDiv.innerText = `Error: ${err}`;
    }
});
</script>
</body>
</html>
